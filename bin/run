#!/usr/bin/env node

import { resolve } from 'node:path';
import { fileURLToPath } from 'node:url';
import { spawn } from 'node:child_process';
import chalk from 'chalk';


// Constants

export const VITE_FILE_URL = import.meta.url;


// Variables

export const dir = fileURLToPath(VITE_FILE_URL);

export const viteRoot = resolve(dir, '../..');

export const viteConfigFilename = resolve(dir, '../../vite.config.ts');


// Functions

export function log(message, color) {
    const handle = chalk[color] ?? chalk.green;

    if (!handle) {
        console.log(chalk.yellow(`(!) Paris Internal Error: Unknown color '${color}'`))
        console.log(message);

        return;
    }

    console.log(handle(message));
}

export function use() {
    return new Promise((resolve, reject) => {

        // Getting the vite server

        const vite = spawn('vite', [ viteRoot, '--config', viteConfigFilename ]);

        vite.stdout.on('data', data => log(data));

        vite.stderr.on('data', data => reject(data));

        vite.on('close', code => resolve(code));


        // Logging the message

        log('(+) Paris: Server started');
    })
}


use().catch(console.error);
